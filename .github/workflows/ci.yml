name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest -q

      - name: Run demo-quick pipeline
        run: make demo-quick

      - name: Validate demo-quick manifest
        run: python scripts/validate_manifest.py outputs/demo_quick/manifest.json

      - name: Run demo-quick-weekly-gas pipeline
        run: make demo-quick-weekly-gas

      - name: Validate demo-quick-weekly-gas manifest
        run: python scripts/validate_manifest.py outputs/demo_quick_weekly_gas/manifest.json

      - name: Run sensitivity-quick pipeline
        run: make sensitivity-quick

      - name: Validate sensitivity-quick manifest
        run: python scripts/validate_manifest.py outputs/sensitivity_quick/manifest.json

      - name: Verify determinism (run demo twice)
        run: |
          # Determinism check: With fixed NumPy seed and pyvinecopulib seeds,
          # two runs with identical inputs must produce identical numeric outputs.

          # Save first run artifacts (demo-quick already ran above)
          cp outputs/demo_quick/backtest_summary.csv /tmp/backtest_run1.csv
          cp outputs/demo_quick/dm_tests.csv /tmp/dm_tests_run1.csv
          cp outputs/demo_quick/metrics.json /tmp/metrics_run1.json
          cp outputs/demo_quick/vine_model_card_gas.json /tmp/vine_model_card_gas_run1.json
          cp outputs/demo_quick/vine_model_card_static.json /tmp/vine_model_card_static_run1.json

          # Clean and run again
          rm -rf outputs/demo_quick/*
          python scripts/run_var_es_backtest.py --config configs/demo_quick.yaml

          # Compare key artifacts exactly
          for f in backtest_summary.csv dm_tests.csv metrics.json vine_model_card_gas.json vine_model_card_static.json; do
            if ! diff /tmp/${f%.*}_run1.${f##*.} outputs/demo_quick/$f > /dev/null 2>&1; then
              # For metrics.json, compare ignoring timestamps
              if [ "$f" = "metrics.json" ]; then
                python3 -c "
          import json
          m1 = json.load(open('/tmp/metrics_run1.json'))
          m2 = json.load(open('outputs/demo_quick/metrics.json'))
          # Remove timestamp fields before comparison
          for m in [m1, m2]:
              m.pop('produced_utc', None)
          assert m1 == m2, f'metrics.json differs beyond timestamp'
          print('metrics.json: OK (ignoring timestamp)')
          "
              else
                echo "FAIL: $f differs between runs"
                diff /tmp/${f%.*}_run1.${f##*.} outputs/demo_quick/$f | head -20
                exit 1
              fi
            else
              echo "$f: OK (identical)"
            fi
          done
          echo "Determinism check passed: all key artifacts identical across runs"

      - name: Validate order_source in model cards
        run: |
          python -c "
          import json

          for fname in ['outputs/demo_quick/vine_model_card_static.json',
                        'outputs/demo_quick/vine_model_card_gas.json']:
            card = json.load(open(fname))
            assert card['order_source'] == 'train_only_fixed', \
              f'{fname}: expected train_only_fixed, got {card[\"order_source\"]}'
          print('Order source validation passed: no OOS leakage in structure selection')
          "
